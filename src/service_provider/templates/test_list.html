{% extends "base.html" %}

{% block content %}

<div id="instructions" class="jumbotron">
    <p>This service can test a SAML Identity Providers (IdP) entity category compliance.</p>

    <p>
        To get started <a href="/upload_metadata">upload the metadata</a> of the IdP.
        Then start testing by following the instructions below.
    </p>

    <p>An overview of test results from previously tested IdP's is available <a href="/overview">here</a>
    </p>

    <div class="panel panel-default">
        <div class="panel-heading" id="heading_instructions">
            <a class="accordion-toggle collapsed" data-toggle="collapse"
               href="#collapse_instructions" aria-expanded="false" aria-controls="collapse_instructions"
               role="button">
                <h4 class="no-margin">
                    Instructions
                </h4>
            </a>
        </div>
        <div id="collapse_instructions" class="panel-collapse collapse" aria-labelledby="heading_instructions">
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-6">
                        <p>
                            To start a test click on the run test button on the row of the test you
                            would like to run. If you want to start all tests click on the Run all
                            test button above the test list. You will be prompted to choose which
                            IdP to use before the test begins.
                        </p>

                        <p>
                            If you want more information about a test or the response generated by a
                            test click anywhere on the row of the test.
                        </p>
                    </div>
                    <div id="test_status" class="col-md-6">
                        <span class="h3">Possible test status</span>
                        <table>
                            <tr>
                                <td>
                                    <div class="status-help-box status-not-run">Not run</div>
                                </td>
                                <td>Test has not been run.</td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="status-help-box status-ok">OK</div>
                                </td>
                                <td>Tested IdP returned the correct attributes.</td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="status-help-box status-too-few">Too few</div>
                                </td>
                                <td>Tested IdP returned too few attributes.</td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="status-help-box status-too-many">Too many</div>
                                </td>
                                <td>Tested IdP returned too many attributes.</td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="status-help-box status-too-few-too-many">Too few &
                                        too
                                        many
                                    </div>
                                </td>
                                <td>Tested IdP returned too few and too many attributes.</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<h2>Available tests</h2>

<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
    {% for test_id, test_info in tests|dictsort %}
        {% if test_id in test_results and test_results[test_id].status %}
            {% set status_css_class, status_text =
                {
                   0: ('status-not-run', 'Not run'),
                   1: ('status-ok', 'OK'),
                   2: ('status-too-few', 'Too few'),
                   3: ('status-too-many', 'Too many'),
                   4: ('status-too-few-too-many', 'Too few & too many')
                }[test_results[test_id].status]
            %}
        {% else %}
            {% set status_css_class, status_text =  ('status-not-run', 'Not run') %}
        {% endif %}


        <div class="panel panel-default">
             <div class="{{ status_css_class }} border-below">
                <div class="panel-heading" role="tab" id="heading_{{test_id}}">
                    <div class="row">
                        <!--Make sure the columns of the row only adds upp to 11 to leave room for icon showing collapsed/expandend (from class .accordion-toggle:before) -->
                        <a class="accordion-toggle collapsed" data-toggle="collapse" role="button" data-parent="#accordion" href="#collapse_{{test_id}}" aria-controls="collapse_{{test_id}}" aria-expanded="false">
                            <h3 class="col-md-6 no-margin">
                                {{ test_info.short_name }}
                            </h3>
                        </a>
                        <div class="col-md-3">Status: {{ status_text }}</div>

                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-primary pull-right"
                                    onclick="runTest('{{ test_id }}');">Run test
                            </button>
                        </div>
                    </div>
                </div>
             </div>

            <div id="collapse_{{test_id}}" class="panel-collapse collapse collapsed" role="tabpanel"
                 aria-labelledby="heading_{{test_id}}">
                <div class="panel-body">
                    <div class="row border-between">
                        <div class="col-md-6">
                            <h4>Test result</h4>
                            {% if test_id in test_results %}
                                {% if test_results[test_id]|length == 0 %}
                                    Perfect match.
                                {% endif %}
                                {% if test_results[test_id].extra_attributes|length > 0 %}
                                    The following parameters should NOT be returned:
                                    <ul>
                                        {% for item in test_results[test_id].extra_attributes %}
                                        <li>{{ item }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                {% if test_results[test_id].missing_attributes|length > 0 %}
                                    The following parameters should be returned:
                                    <ul>
                                        {% for item in test_results[test_id].missing_attributes %}
                                        <li>{{ item }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                            {% else %}
                                No result exists.
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            {% for description in test_info.descriptions %}
                                <h4>{{ description.title }}</h4>
                                {{ description.text }}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

{% endblock %}